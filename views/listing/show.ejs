<% layout('layouts/boilorPlate.ejs') %>
<div class="container-fluid py-3">
  <div class="row justify-content-center">
    <div class="col-12 d-flex justify-content-center">
      <div
        class="card shadow-lg border-0 rounded-4 overflow-hidden animate__animated animate__fadeInUp listing-card custom-wide-card"
      >
        <!-- Card Header -->
        <div class="card-header listing-header py-1">
          <h1 class="card-title mb-0 text-center fw-bold text-white">
            <i class="fas fa-home me-2"></i><%= Listing.title %>
          </h1>
        </div>

        <!-- Card Body -->
        <div class="card-body p-0">
          <!-- Image Section -->
          <% if (Listing.image && Listing.image.url) { %>
          <div class="position-relative overflow-hidden">
            <img
              src="<%= Listing.image.url %>"
              alt="Listing Image"
              class="w-100 listing-image"
              style="
                height: 200px;
                object-fit: cover;
                transition: transform 0.3s ease;
              "
            />
            <div class="position-absolute top-0 end-0 m-3">
              <span class="badge status-badge fs-6 px-3 py-2">
                <i class="fas fa-tag me-1"></i>Available
              </span>
            </div>
          </div>
          <% } %>

          <!-- Content Section -->
          <div class="p-2 content-section">
            <!-- Description -->
            <div class="mb-3">
              <div class="mb-2 text-muted small">
                <i class="fas fa-user me-1"></i>
                Owner <strong><%= Listing.owner.username %></strong>
              </div>
              <h5 class="section-title mb-2">
                <i class="fas fa-info-circle me-2"></i>Description
              </h5>
              <p class="description-text"><%= Listing.description %></p>
            </div>

            <!-- Price and Location Section -->
            <div class="row mb-2 g-2">
              <div class="col-lg-6 col-md-6">
                <div class="info-card price-card">
                  <h6 class="info-label">
                    <i class="fas fa-indian-rupee-sign me-1"></i>Price
                  </h6>
                  <h3 class="price-text">
                    &#8377;<%= Listing.price.toLocaleString("en-in") %>
                  </h3>
                </div>
              </div>
              <div class="col-lg-6 col-md-6">
                <div class="info-card location-card">
                  <h6 class="info-label">
                    <i class="fas fa-map-marker-alt me-1"></i>Location
                  </h6>
                  <h5 class="location-text"><%= Listing.location %></h5>
                </div>
              </div>
            </div>

            <!-- Country -->
            <div class="mb-2">
              <div class="info-card country-card">
                <h6 class="info-label">
                  <i class="fas fa-globe me-1"></i>Country
                </h6>
                <h5 class="country-text"><%= Listing.country %></h5>
              </div>
            </div>

            <!-- Action Buttons -->
            <% if(currentUser && Listing.owner.equals(currentUser._id)){ %>
            <div class="d-flex gap-3 flex-wrap action-buttons">
              <a
                href="/listing/<%= Listing._id %>/edit"
                class="btn edit-btn btn-lg flex-fill animate__animated animate__pulse animate__infinite animate__slower"
              >
                <i class="fas fa-edit me-2"></i>Edit Listing
              </a>
              <form
                action="/listing/<%=Listing._id%>?_method=DELETE"
                method="POST"
                class="flex-fill"
              >
                <button
                  type="submit"
                  class="btn delete-btn btn-lg w-100 animate__animated animate__pulse animate__infinite animate__slower"
                  onclick="return confirm('Are you sure you want to delete this listing?')"
                >
                  <i class="fas fa-trash me-2"></i>Delete Listing
                </button>
              </form>
            </div>
            <% } %>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
<hr />
<% if(currentUser) {%>
<div class="review-form-container">
  <h4 class="review-form-title">Leave a Review</h4>
  <form
    action="/listing/<%= Listing._id %>/reviews"
    method="POST"
    novalidate
    class="needs-validation"
  >
    <div class="mb-3">
      <label for="rating" class="form-label" style="font-weight: 500"
        >Rating</label
      >
      <input
        type="range"
        min="1"
        max="5"
        name="review[rating]"
        class="form-range"
        style="width: 100%"
      />
      <div
        style="
          display: flex;
          justify-content: space-between;
          font-size: 0.9rem;
          color: var(--gray-color);
        "
      >
        <span>1</span><span>2</span><span>3</span><span>4</span><span>5</span>
      </div>
    </div>
    <div class="mb-3">
      <label for="comment" class="form-label" style="font-weight: 500"
        >Comment</label
      >
      <textarea
        name="review[comment]"
        id="comment"
        class="form-control"
        rows="3"
        placeholder="Write your thoughts..."
        style="resize: vertical"
        required
      ></textarea>
    </div>
    <button
      type="submit"
      class="btn btn-primary btn-animate"
      style="
        background: var(--primary-color);
        border: none;
        border-radius: 0.5rem;
        padding: 0.5rem 1.5rem;
        font-weight: 500;
      "
    >
      Submit Review
    </button>
  </form>
</div>
<% } %>

<!-- Reviews Section -->
<div class="reviews-container">
  <h4 class="review-form-title">Reviews</h4>
  <div class="review-list">
    <!-- Debug info -->
    <p>Total reviews: <%= Listing.reviews ? Listing.reviews.length : 0 %></p>
    <% if(Listing.reviews && Listing.reviews.length > 0) { %> <% for(let review
    of Listing.reviews){ %>
    <div class="review-item d-flex align-items-center justify-content-between">
      <div>
        <div class="d-flex align-items-center mb-1">
          <i
            class="fas fa-user-circle me-2"
            style="font-size: 1.5rem; color: var(--primary-color)"
          ></i>
          <span style="font-weight: 600; font-size: 1.1rem"
            >@<%= review.author.username %></span
          >
        </div>
        <h5 class="review-rating mb-1">Rating: <%= review.rating %></h5>
        <p class="review-comment mb-0"><%= review.comment %></p>
      </div>
      <form
        action="/listing/<%= Listing._id %>/reviews/<%= review._id %>?_method=DELETE"
        method="POST"
        class="ms-3"
      >
        <button
          type="submit"
          class="btn btn-outline-danger btn-sm"
          title="Delete review"
          onclick="return confirm('Are you sure you want to delete this review?')"
        >
          <i class="fas fa-trash"></i>
        </button>
      </form>
    </div>
    <% } %> <% } %>
  </div>
</div>

<style></style>
